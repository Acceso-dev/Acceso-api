// ==============================================
// API.ACCESO.DEV - Prisma Schema
// ==============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==============================================
// User & Authentication Models
// ==============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  tier      UserTier @default(FREE)
  status    UserStatus @default(ACTIVE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  apiKeys      ApiKey[]
  usageMetrics UsageMetrics[]
  webhooks     Webhook[]
  workflows    Workflow[]

  @@map("users")
}

model ApiKey {
  id           String       @id @default(cuid())
  userId       String       @map("user_id")
  name         String
  keyHash      String       @unique @map("key_hash")
  keyPrefix    String       @map("key_prefix")
  tier         ApiKeyTier   @default(FREE)
  status       ApiKeyStatus @default(ACTIVE)
  permissions  String[]     @default(["read"])
  rateLimit    Int          @default(100) @map("rate_limit")
  lastUsedAt   DateTime?    @map("last_used_at")
  expiresAt    DateTime?    @map("expires_at")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageMetrics UsageMetrics[]

  @@index([keyHash])
  @@index([userId])
  @@map("api_keys")
}

model UsageMetrics {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  apiKeyId    String   @map("api_key_id")
  endpoint    String
  method      String
  statusCode  Int      @map("status_code")
  latencyMs   Int      @map("latency_ms")
  requestSize Int?     @map("request_size")
  responseSize Int?    @map("response_size")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([apiKeyId, createdAt])
  @@index([endpoint, createdAt])
  @@map("usage_metrics")
}

// ==============================================
// Webhook Models
// ==============================================

model Webhook {
  id          String        @id @default(cuid())
  userId      String        @map("user_id")
  name        String
  url         String
  secret      String
  events      String[]
  status      WebhookStatus @default(ACTIVE)
  retryCount  Int           @default(0) @map("retry_count")
  maxRetries  Int           @default(5) @map("max_retries")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([userId])
  @@index([status])
  @@map("webhooks")
}

model WebhookDelivery {
  id           String                @id @default(cuid())
  webhookId    String                @map("webhook_id")
  event        String
  payload      Json
  status       WebhookDeliveryStatus @default(PENDING)
  statusCode   Int?                  @map("status_code")
  response     String?
  attempts     Int                   @default(0)
  nextRetryAt  DateTime?             @map("next_retry_at")
  deliveredAt  DateTime?             @map("delivered_at")
  createdAt    DateTime              @default(now()) @map("created_at")

  // Relations
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, status])
  @@index([status, nextRetryAt])
  @@map("webhook_deliveries")
}

// ==============================================
// Workflow Models
// ==============================================

model Workflow {
  id          String         @id @default(cuid())
  userId      String         @map("user_id")
  name        String
  description String?
  trigger     Json
  steps       Json
  status      WorkflowStatus @default(DRAFT)
  version     Int            @default(1)
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  // Relations
  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  executions WorkflowExecution[]

  @@index([userId, status])
  @@map("workflows")
}

model WorkflowExecution {
  id          String                  @id @default(cuid())
  workflowId  String                  @map("workflow_id")
  status      WorkflowExecutionStatus @default(PENDING)
  input       Json?
  output      Json?
  error       String?
  startedAt   DateTime?               @map("started_at")
  completedAt DateTime?               @map("completed_at")
  createdAt   DateTime                @default(now()) @map("created_at")

  // Relations
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, status])
  @@index([status, createdAt])
  @@map("workflow_executions")
}

// ==============================================
// Solana Models
// ==============================================

model Transaction {
  id          String            @id @default(cuid())
  signature   String            @unique
  slot        BigInt
  blockTime   DateTime?         @map("block_time")
  status      TransactionStatus @default(PENDING)
  type        String?
  fromAddress String?           @map("from_address")
  toAddress   String?           @map("to_address")
  amount      Decimal?          @db.Decimal(20, 9)
  fee         Decimal?          @db.Decimal(20, 9)
  mint        String?
  data        Json?
  createdAt   DateTime          @default(now()) @map("created_at")

  @@index([signature])
  @@index([fromAddress])
  @@index([toAddress])
  @@index([blockTime])
  @@map("transactions")
}

model PriceCache {
  id        String   @id @default(cuid())
  symbol    String
  source    String
  price     Decimal  @db.Decimal(20, 8)
  volume24h Decimal? @map("volume_24h") @db.Decimal(20, 2)
  change24h Decimal? @map("change_24h") @db.Decimal(10, 4)
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([symbol, source])
  @@index([symbol])
  @@map("price_cache")
}

// ==============================================
// ZK Proof Models
// ==============================================

model ZkProof {
  id          String        @id @default(cuid())
  circuitId   String        @map("circuit_id")
  circuitName String        @map("circuit_name")
  inputHash   String        @map("input_hash")
  proof       Json
  publicInputs Json         @map("public_inputs")
  status      ZkProofStatus @default(PENDING)
  verified    Boolean       @default(false)
  verifiedAt  DateTime?     @map("verified_at")
  generatedAt DateTime?     @map("generated_at")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([circuitId])
  @@index([status])
  @@map("zk_proofs")
}

model ZkCircuit {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String?
  version      String   @default("1.0.0")
  wasmPath     String?  @map("wasm_path")
  zkeyPath     String?  @map("zkey_path")
  vkeyPath     String?  @map("vkey_path")
  publicInputs String[] @map("public_inputs")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("zk_circuits")
}

// ==============================================
// Rate Limiting Model
// ==============================================

model RateLimit {
  id        String   @id @default(cuid())
  key       String   @unique
  count     Int      @default(0)
  windowStart DateTime @map("window_start")
  expiresAt DateTime @map("expires_at")

  @@index([key])
  @@index([expiresAt])
  @@map("rate_limits")
}

// ==============================================
// Enums
// ==============================================

enum UserTier {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum ApiKeyTier {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum WebhookStatus {
  ACTIVE
  PAUSED
  DISABLED
}

enum WebhookDeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
}

enum WorkflowStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum WorkflowExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
}

enum ZkProofStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
  VERIFIED
}
